# CAP理论

对一个分布式系统中,当涉及读写操作时只能保证`一致性(Consistency)`,`可用性(Availability)`,`分区容错性(Partition tolerance)`三者中的两个,另外一个必须被牺牲.

## 一致性(Consistency)

保证对于一个客户端而言,每一次的读操作返回的一定是最新的写操作的结果.因为在一个事务处理过程中分布式中每一个节点所拥有的数据是动态的并不会完全一致.对于客户端而言,读到的一定是读提交级别的数据或是事务失败回滚的初始数据.

狭义的一致性要求所有节点在所有时刻数据一致,广义的一致性则放松了要求.一般我们将广义的一致性分为2种--一致性和最终一致性

举例来说,总共有节点`a`,`b`,如果说原本存的数据`x`值为`x_o`

+ 当`b`收到将`x`改为`x_1`时`a`可以和`b`同时将内存存储的`x`的值改为`x_1`则称为`强一致性`或者`线性一致性`
+ 如果`b`会先把自己存的`x`值改掉然后通知`a`也改,并且可以保证`a`最终也会被改为`x_1`则称为`最终一致性`
+ 如果上面的都不能满足就不满足一致性要求

其实最终一致性也不满足狭义的一致性要求,只是一种妥协或者说商业用语.

## 可用性(Availability)

指非故障的节点在合理的时间内返回合理的响应.我们可以简单理解为只要收到客户端的请求,系统就必须可以给出返回的能力.

## 分区容错性(Partition tolerance)

指当出现网络分区后系统能够继续"履行职责".

大多数分布式系统都分布在多个子网络,每个子网络就叫做一个区(partition).分区带来的是可扩展,但同时也会带来区间通信可能会失败.比如一台服务器放在中国,另一台服务器放在美国,这就是两个区,它们之间可能无法通信.

分区容错的意思是在区间通信失败的情况下系统依然可以正常运行.满足分区容错的一个极端方式就是不进行分区,也就是只有一个分区.没有分区自然也就不是分布式系统,也就没有可扩展一说.

## 一致性和可用性的矛盾

一致性和可用性为什么不可能同时成立?因为可能通信失败(即出现分区容错).以上面的例子的模型我们来探讨:

+ 如果保证`a`的一致性,那么`b`必须在写操作时锁定`a`的读操作和写操作.只有数据同步后才能重新开放读写,锁定期间`a`不能读写也就没有可用性.

+ 如果保证`a`的可用性,那么势必不能锁定它,所以一致性不成立.

目前大多数分布式数据库都是保证可用性的前提下做到最终一致性.

## 不同偏向组合的常见应用场景

+ `CA`满足数据的一致性和高可用性,但没有可扩展性.如传统的关系型数据的单点部署方案基本上满足是这个解决方案.
+ `CP`满足数据的一致性和分区性,如ETCD集群,zookeeper集群等.
+ `AP`在性能和可扩展性方面表现不错,但在数据一致性方面会用牺牲,各节点的之间数据同步没有那么快,但能保存数据的最终一致性.比如MongoDB集群,Cassandra集群,等都是这一思路.
